#!/usr/bin/env python

import rospy
import roslib
import actionlib
import time
import math
from move_base_msgs.msg import MoveBaseAction, MoveBaseGoal
from actionlib import SimpleActionClient, GoalStatus
from geometry_msgs.msg import *
#initial position of the robot
robotx = -0.18494489789
roboty = -0.413082122803

def distanceToRobot(x1, y1, x2, y2):
    return math.sqrt(math.pow((x2 - x1), 2) + math.pow((y2 - y1), 2))


def minDistIndex(list):
    minDistListIndex = 0
    minDist = 999999999999
    for i in list:
        dist = distanceToRobot(i[0][0],i[0][1],robotx,roboty)
        if dist < minDist:
                minDist = dist
                minDistListIndex = list.index(i)
    return list.pop(minDistListIndex)


def talker(x , y , z , w):
    t = int(time.time())
    sac = actionlib.SimpleActionClient('robot1/move_base', MoveBaseAction)
    rospy.loginfo('Sending point')
    sac.wait_for_server()
    goal = MoveBaseGoal()    #use self?
    #set goal
    goal.target_pose.header.frame_id = 'robot1_tf/odom'
    goal.target_pose.header.stamp = rospy.Time.now()
    goal.target_pose.pose.position.x = x
    goal.target_pose.pose.position.y = y
    goal.target_pose.pose.orientation.z = z
    goal.target_pose.pose.orientation.w = w

    #start listner
    #sac.wait_for_server()

    #send goal
    sac.send_goal(goal)
    #finish
    sac.wait_for_result(rospy.Duration(20))

    
    if sac.get_state() == GoalStatus.SUCCEEDED:
        rospy.loginfo('Done')
    else:
        rospy.loginfo('Fail')
        time.sleep(10)
        sac.cancel_goal()
        sac.send_goal(goal)

def callback(data):
    global robotx
    global roboty
    #location of the robot
    robotx = data.polygon.points[3].x
    roboty = data.polygon.points[3].y
    #rospy.loginfo(robotx)

if __name__ == '__main__':
    try:
        rospy.init_node('talker', anonymous=True)
        rospy.Subscriber('/robot1/move_base/global_costmap/footprint', PolygonStamped, callback)
        list = [[[-0.903720378876,-4.29677248001,-0.0515126451113,0.998672342359],[-6.01473045349,-3.52039575577,0.995658490814,-0.0930815216309],[-0.781385421753,-4.55504274368,0.756097915801,-0.654458510313]],[[0.186694741249,-9.12084007263,0.999969047863,0.00786786607683],[6.10726737976,-8.56509971619,-0.0753811622587,0.997154792586],[0.159509420395,-9.0634469986,0.610453373386,-0.792052194569]],[[-0.837352633476,-11.8545589447,0.0106424376243,0.999943367657],[-4.79295158386,-11.5146856308,0.999150721903,-0.0412047924462],[-0.689335584641,-11.5736351013,0.713277526398,-0.700881709231]],[[-0.390370965004,-18.8807029724,0.00318013838211,0.999994943347],[-4.91234827042,-18.4577541351,0.996291338156,-0.0860439975548],[-0.542914271355,-18.7070121765,0.718411350253,-0.695618524643]],[[-0.404040455818,-25.5277442932,0.00102784281932,0.999999471769],[-6.15090465546,-24.5957946777,0.994947146641,-0.100400076652],[-0.148790955544,-25.5473823547,0.70637927194,-0.707833542701]],[[0.612369537354,-30.4922676086,0.999293415861,0.0375854894503],[5.64183092117,-30.4288902283,-0.0277403757137,0.999615161727],[0.586696147919,-30.3638896942,0.674085057583,-0.738653731557]],[[-0.450944900513,-33.0689086914,-0.0309233852404,0.999521757765],[-4.95177412033,-32.3197250366,0.993756421407,-0.111571389306],[-0.0084114074707,-32.9646987915,0.763764167197,-0.645495388757]],[[0.781451225281,-37.2284240723,0.999263132567,-0.0383821819775],[6.57968044281,-37.0819854736,-0.0167271586403,0.999860091295],[0.813170433044,-37.0728607178,0.64712497094,-0.762383940011]],[[-0.346804141998,-39.5196075439,-0.00201409370977,0.999997971711],[-5.17991495132,-39.0332260132,0.999001972755,-0.0446660769593],[-0.130824029446,-39.3821754456,0.709131722796,-0.705076024074]],[[-0.0593390464783,-43.5506057739,0.999916401648,-0.0129301861885],[4.83149003983,-43.8998413086,0.0654108023556,0.997858420286],[0.0803952217102,-43.3896026611,0.61877376843,-0.785569235334]],[[-1.20754766464,-46.7600402832,0.0633487632265,0.997991449962],[-6.39001893997,-45.7060394287,0.996349061073,-0.0853729963099],[-0.785303115845,-46.5337104797,0.727184171222,-0.686442409182]],[[0.0705122947693,-51.1116142273,0.998076730239,0.061990648932],[4.5464630127,-50.9163742065,0.021869118702,0.999760842225],[-0.448395490646,-50.8661880493,0.701476743017,-0.71269234527]],[[-1.37502551079,-53.4364471436,0.0136988122416,0.999906166869],[-6.24298763275,-52.7105674744,0.991173369414,-0.132572062535],[-0.917730093002,-53.2936401367,0.742047364011,-0.670347454358]],[[-0.159719228745,-57.9963531494,0.999559896733,0.0296650104349],[4.82952976227,-57.789894104,-0.00774323827926,0.999970020681],[-0.404228925705,-58.152217865,0.616924230041,-0.787022550114]],[[-1.59311842918,-60.4714393616,-0.0267929677399,0.999641004001],[-5.71724891663,-60.154296875,0.999530530469,-0.0306385159526],[-1.00423312187,-60.2726287842,0.775736685508,-0.631056728636]],[[0.141095399857,-65.2767715454,0.998538965308,-0.0540364206915],[5.32446193695,-65.0395050049,-0.0165141058688,0.999863632856],[-0.371284246445,-64.924949646,0.596561917982,-0.802567055151]],[[-1.4164454937,-67.3384246826,0.0484718082459,0.998824551063],[-5.94003200531,-66.5696029663,0.996181730312,-0.0873038383568],[-1.10940432549,-67.2077560425,0.719437697453,-0.694556980732]],[[-1.99850082397,-74.7355270386,0.0102462083436,0.999947506229],[-6.50250291824,-73.6475219727,0.984486857416,-0.175458335725],[-1.89210748672,-74.7420501709,0.999530500068,-0.0306395077166]],[[1.474214077,-75.2262802124,0.634986400749,-0.772523314123],[0.7940325737,-79.3494949341,0.744283110042,0.667864246765],[1.30529069901,-75.1945571899,0.998462942457,0.0554233934431]],[[3.68694353104,-73.973739624,0.694556750743,0.719437919488],[3.78670740128,-71.651763916,0.742047319284,-0.670347503869],[3.27912092209,-74.3545303345,0.995118867519,-0.0986835321049]],[[8.20216560364,-75.5750427246,0.739096401981,-0.673599664918],[7.69182634354,-79.3669433594,0.80438741765,0.594105110503],[8.32814407349,-75.2623901367,0.998462943191,0.0554233802085]],[[12.4793071747,-74.7909240723,0.773434783428,0.633875883579],[12.8393936157,-71.0111694336,0.691473000896,-0.722402304143],[12.4046382904,-74.6154708862,0.992740493127,-0.12027598807]],[[15.675786972,-75.6064682007,0.737775636584,-0.675046005886],[15.3026447296,-79.5990066528,0.793903271285,0.608044073932],[15.4191398621,-75.6120758057,0.0858654551403,0.996306741728]]]

        for i in range(0,len(list)):
		    #nearRoom = nearest outside point's room in the map from the robot's position
			nearRoom = minDistIndex(list)
			for j in nearRoom:
				talker(j[0],j[1],j[2],j[3])
    except rospy.ROSInterruptException:
        pass
