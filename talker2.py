#!/usr/bin/env python

import rospy
import roslib
import actionlib
import time
import math
from move_base_msgs.msg import MoveBaseAction, MoveBaseGoal
from actionlib import SimpleActionClient, GoalStatus
from geometry_msgs.msg import *
#initial position of the robot
robotx = -0.107364242298
roboty = 0.105676295949

def distanceToRobot(x1, y1, x2, y2):
    return math.sqrt(math.pow((x2 - x1), 2) + math.pow((y2 - y1), 2))


def minDistIndex(list):
    minDistListIndex = 0
    minDist = 999999999999
    for i in list:
        dist = distanceToRobot(i[0][0],i[0][1],robotx,roboty)
        if dist < minDist:
                minDist = dist
                minDistListIndex = list.index(i)
    return list.pop(minDistListIndex)


def talker(x , y , z , w):
    t = int(time.time())
    sac = actionlib.SimpleActionClient('robot2/move_base', MoveBaseAction)
    rospy.loginfo('Sending point')
    sac.wait_for_server()
    goal = MoveBaseGoal()    #use self?
    #set goal
    goal.target_pose.header.frame_id = 'robot2_tf/odom'
    goal.target_pose.header.stamp = rospy.Time.now()
    goal.target_pose.pose.position.x = x
    goal.target_pose.pose.position.y = y
    goal.target_pose.pose.orientation.z = z
    goal.target_pose.pose.orientation.w = w

    #start listner
    #sac.wait_for_server()

    #send goal
    sac.send_goal(goal)
    #finish
    sac.wait_for_result(rospy.Duration(20))

    
    if sac.get_state() == GoalStatus.SUCCEEDED:
        rospy.loginfo('Done')
    else:
        rospy.loginfo('Fail')
        time.sleep(10)
        sac.cancel_goal()
        sac.send_goal(goal)

def callback(data):
    global robotx
    global roboty
    #location of the robot
    robotx = data.polygon.points[3].x
    roboty = data.polygon.points[3].y
    #rospy.loginfo(robotx)

if __name__ == '__main__':
    try:
        rospy.init_node('talker', anonymous=True)
        rospy.Subscriber('/robot2/move_base/global_costmap/footprint', PolygonStamped, callback)
        list =[[[-0.532611846924,-4.24543857574,-0.0203424992776,0.999793069952],[-5.19995212555,-3.65040874481,0.998566112533,-0.053532409825],[-0.122734069824,-3.93016910553,0.719142377755,-0.694862749409]],[[0.692667007446,-8.87893390656,0.99813458008,0.061052109281],[4.43917274475,-8.69286441803,-0.00218727356245,0.999997607914],[0.442228317261,-8.82538509369,0.657792766907,-0.753198961632]],[[-0.384742736816,-11.7509355545,0.0105800097294,0.999944030131],[-4.24721717834,-11.0661096573,0.9981405478,-0.0609544652802],[-0.25267791748,-11.6985902786,0.731922854074,-0.681387507726]],[[-0.326668739319,-18.4515686035,-0.0159026951806,0.999873544147],[-4.96783924103,-17.9225730896,0.992634813071,-0.121145069562],[-0.326668739319,-18.4515686035,0.730176323172,-0.683258762899]],[[-0.677271842957,-25.0849647522,-0.0544714914783,0.99851532618],[-5.60873889923,-24.5946273804,0.998140580215,-0.0609539344742],[0.00801277160645,-25.2717781067,0.675952037257,-0.736945617619]],[[0.640210151672,-29.7583236694,0.998301650188,-0.0582564608526],[4.80667209625,-30.246257782,-0.0278021768871,0.999613444768],[0.665181159973,-30.2068519592,0.612865201085,-0.79018747478]],[[-0.383646011353,-32.3798904419,-0.129759699327,0.991545470682],[-4.98375225067,-31.3761825562,0.984504824827,-0.175357491694],[-0.133209228516,-32.4334335327,0.759368019337,-0.650661364466]],[[1.02483654022,-37.475605011,0.99989782198,0.0142949501362],[4.63927841187,-37.3418769836,0.0175228618681,0.999846462869],[1.15810203552,-37.0407562256,0.594552120316,-0.804057072743]],[[-0.431467056274,-39.1988945007,0.0431290881644,0.999069507969],[-4.36117744446,-38.922744751,0.999471735656,-0.0324999942213],[-0.207201004028,-39.1864128113,0.752329280799,-0.658787259479]],[[0.900904178619,-43.3315048218,0.999984992175,-0.00547863351967],[5.04359912872,-42.9884033203,-0.0985941889528,0.995127723413],[0.768841266632,-43.3838500977,0.58084535142,-0.814013929693]],[[-0.334739685059,-46.1898231506,-0.146580386654,0.98919876175],[-3.64519691467,-46.1266555786,0.999656798704,-0.0261970380746],[0.284516334534,-46.4028091431,0.667338374015,-0.744754653941]],[[1.15466594696,-50.7186279297,0.998088250162,0.061804893727],[4.86131286621,-50.6247634888,-0.00509463200318,0.999987022278],[1.04997730255,-50.4545021057,0.694607260198,-0.719389153436]],[[-0.0797758102417,-53.194442749,-0.0190337690046,0.99981884141],[-4.24623584747,-52.7065048218,0.995680749987,-0.0928431155507],[0.487133979797,-53.2753639221,0.736817442233,-0.676091751778]],[[1.56786346436,-57.7369346619,0.998618202468,-0.0525517430674],[5.4178571701,-58.1974945068,0.059495018502,0.998228602462],[1.00095558167,-57.6560134888,0.622009886051,-0.783009387973]],[[0.200159072876,-60.6475982666,0.022744669414,0.999741306545],[-3.12278366089,-60.3601608276,0.997651737573,-0.0684909520797],[0.490456581116,-60.6089363098,0.756885217105,-0.653547831554]],[[1.70325374603,-65.0181655884,0.999984995273,-0.00547806793116],[5.66033935547,-64.9778518677,0.027520193396,0.999621247751],[1.16251564026,-65.0032806396,0.628853494364,-0.777523814829]],[[-0.0046911239624,-67.0704193115,0.00157323559127,0.999998762464],[-3.30146026611,-66.8490142822,0.997721849475,-0.0674619231804],[0.194606781006,-66.6093978882,0.726492702279,-0.68717417991]],[[-0.304152488708,-74.2183837891,0.00157323657188,0.999998762463],[-3.64078044891,-74.0891799927,0.999956795407,0.00929555374215],[0.473338127136,-74.4450531006,0.998773567878,0.049511211938]],[[3.03127384186,-74.7300872803,0.762422854134,-0.647079123056],[3.02165412903,-77.7901000977,0.691876895777,0.722015485353],[3.37391662598,-74.8234863281,0.989198930014,0.146579251119]],[[6.17461872101,-73.4077911377,0.658787822608,0.752328787688],[5.4590959549,-70.2531585693,0.74124904592,-0.671230103558],[5.89560317993,-74.0532150269,0.999962022222,-0.00871516570139]],[[10.1792411804,-75.0295639038,0.747767856751,-0.66396026418],[10.1309652328,-77.7992858887,0.654551105492,0.756017757925],[10.5492591858,-74.8065032959,0.994026800927,0.109136240721]],[[14.392780304,-73.130279541,0.68717416848,0.72649271309],[14.8098735809,-70.5199966431,0.675951992731,-0.73694565846],[14.4302358627,-73.8030853271,0.999994761355,0.00323685992295]],[[17.7906303406,-74.7633209229,0.726492629451,-0.687174256905],[17.3187885284,-78.0065383911,0.753198939599,0.657792792137],[17.9102096558,-74.4867095947,0.0582578133293,0.998301571263]]]

        for i in range(0,len(list)):
		    #nearRoom = nearest outside point's room in the map from the robot's position
			nearRoom = minDistIndex(list)
			for j in nearRoom:
				talker(j[0],j[1],j[2],j[3])
    except rospy.ROSInterruptException:
        pass
